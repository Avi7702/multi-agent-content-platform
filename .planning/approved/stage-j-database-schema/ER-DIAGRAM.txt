DIFY-AGENT DATABASE SCHEMA - ENTITY-RELATIONSHIP DIAGRAM
========================================================

Version: 1.0.0
Date: November 10, 2025
Total Tables: 30


LEGEND:
=======
[TABLE_NAME]          - Table
──────>               - One-to-Many relationship
═════>                - One-to-One relationship
PK                    - Primary Key
FK                    - Foreign Key
(ENCRYPTED)           - Encrypted data
(SHARED GLOBAL)       - Shared across tenants
(PER-TENANT PRIVATE)  - Isolated per tenant


CORE ARCHITECTURE:
==================

                    ┌─────────────────────────────┐
                    │        tenants (PK)         │
                    │  - tenant_id                │
                    │  - region                   │
                    │  - kms_key_id               │
                    │  - tier                     │
                    └──────────┬──────────────────┘
                               │
                ┌──────────────┼──────────────────────┐
                │              │                      │
                │ 1:N          │ 1:1                  │ 1:N
        ┌───────▼──────┐  ┌────▼───────────────┐  ┌──▼──────────────┐
        │    users     │  │  brand_profiles    │  │ content_        │
        │   (PK)       │  │  (PER-TENANT)      │  │ templates       │
        │ - user_id    │  │  (ENCRYPTED)       │  │ (PK)            │
        │ - tenant_id  │  │ - tenant_id        │  │ - template_id   │
        │ - email      │  │ - embeddings BLOB  │  │ - tenant_id     │
        │ - role       │  │ - palette JSON     │  │ - platform      │
        └──────┬───────┘  │ - typography JSON  │  └─────────────────┘
               │          │ - logo_rules JSON  │
               │ 1:N      │ - kms_key_id       │
        ┌──────▼──────┐  └────────────────────┘
        │  api_keys   │
        │   (PK)      │
        │ - key_id    │
        │ - user_id   │
        │ - scopes    │
        └─────────────┘


CONTENT GENERATION WORKFLOW:
=============================

┌────────────────────────────────────────────────────────────────┐
│                    SKILLS (SHARED GLOBAL)                       │
│  ┌─────────────┐      ┌──────────────┐      ┌───────────────┐ │
│  │   skills    │──1:N─>│skill_versions│──1:N─>│skill_         │ │
│  │   (PK)      │      │   (PK)       │      │embeddings     │ │
│  │ - skill_id  │      │ - version_id │      │  (PK)         │ │
│  │ - name      │      │ - prompt JSON│      │ - vector BLOB │ │
│  │ - platform  │      │ - guards JSON│      │ - tags JSON   │ │
│  │ - visibility│      │ - toolchain  │      └───────────────┘ │
│  │ - status    │      └──────────────┘                         │
│  └──────┬──────┘                                               │
│         │                                                       │
│         │ 1:N                                                   │
│  ┌──────▼──────────────┐                                       │
│  │ skill_metrics_daily │                                       │
│  │      (PK)           │                                       │
│  │ - date              │                                       │
│  │ - skill_id          │                                       │
│  │ - uses              │                                       │
│  │ - pass_rate         │                                       │
│  │ - unique_tenants    │  <- K-anonymity (>= 5)               │
│  └─────────────────────┘                                       │
└────────────────────────────────────────────────────────────────┘
                               │
                               │ references
                               │
            ┌──────────────────▼──────────────────┐
            │       generated_content             │
            │       (PER-TENANT PRIVATE)          │
            │  ┌──────────────────────────┐       │
            │  │ - content_id (PK)        │       │
            │  │ - tenant_id              │       │
            │  │ - skill_id (FK)          │       │
            │  │ - intent_spec JSON       │       │
            │  │ - text_content           │       │
            │  │ - image_url              │       │
            │  │ - brand_voice_score      │       │
            │  │ - guard_pass_rate        │       │
            │  │ - user_selected          │       │
            │  └─────────┬────────────────┘       │
            │            │ 1:N                    │
            │     ┌──────▼──────────┐             │
            │     │ guard_results   │             │
            │     │    (PK)         │             │
            │     │ - result_id     │             │
            │     │ - content_id    │             │
            │     │ - guard_id      │             │
            │     │ - pass BOOL     │             │
            │     │ - auto_fixed    │             │
            │     └─────────────────┘             │
            │            │ 1:N                    │
            │     ┌──────▼──────────┐             │
            │     │revision_events  │             │
            │     │    (PK)         │             │
            │     │ - event_id      │             │
            │     │ - content_id    │             │
            │     │ - classification│ <- defect/preference
            │     │ - labels_defect │             │
            │     │ - user_notes    │             │
            │     └─────────────────┘             │
            └─────────────────────────────────────┘


PUBLISHING PIPELINE:
====================

┌──────────────────┐
│  social_accounts │
│  (ENCRYPTED)     │
│  (PK)            │
│ - account_id     │
│ - tenant_id      │
│ - platform       │
│ - access_token   │  <- AES-256-GCM encrypted
│ - refresh_token  │  <- with per-tenant KMS key
│ - expires_at     │
└────────┬─────────┘
         │
         │ 1:N (Which account published)
         │
┌────────▼──────────────────────────────────────┐
│          published_posts                      │
│          (PER-TENANT)                         │
│  ┌──────────────────────────┐                 │
│  │ - post_id (PK)           │                 │
│  │ - tenant_id              │                 │
│  │ - content_id (FK)        │────references───>generated_content
│  │ - account_id (FK)        │                 │
│  │ - platform               │                 │
│  │ - platform_post_id       │                 │
│  │ - platform_post_url      │                 │
│  │ - text                   │                 │
│  │ - image_url              │                 │
│  │ - published_at           │                 │
│  │ - campaign_id            │                 │
│  └───────┬──────────────────┘                 │
│          │                                     │
└──────────┼─────────────────────────────────────┘
           │
           │ 1:1
           │
    ┌──────▼────────────────────┐
    │    post_analytics         │
    │    (Platform Metrics)     │
    │  ┌─────────────────┐      │
    │  │ - analytics_id  │ (PK) │
    │  │ - post_id       │ (FK) │
    │  │ - likes         │      │
    │  │ - comments      │      │
    │  │ - shares        │      │
    │  │ - impressions   │      │
    │  │ - reach         │      │
    │  │ - engagement_rate│     │
    │  │ - performance_   │     │
    │  │   score         │      │
    │  └─────────────────┘      │
    └───────────────────────────┘
           │
           │ 1:N
           │
    ┌──────▼────────────────────┐
    │      conversions          │
    │      (ROI Tracking)       │
    │  ┌─────────────────┐      │
    │  │ - conversion_id │ (PK) │
    │  │ - post_id       │ (FK) │
    │  │ - conversion_   │      │
    │  │   type          │      │
    │  │ - value (USD)   │      │
    │  │ - utm_campaign  │      │
    │  │ - attribution_  │      │
    │  │   model         │      │
    │  └─────────────────┘      │
    └───────────────────────────┘


ANALYTICS AGGREGATION:
======================

┌──────────────────────────┐
│  performance_benchmarks  │
│  (Rolling 90-day avg)    │
│  ┌───────────────────┐   │
│  │ - benchmark_id    │   │
│  │ - tenant_id       │   │
│  │ - platform        │   │
│  │ - avg_engagement_ │   │
│  │   rate            │   │
│  │ - p90_engagement_ │   │
│  │   rate            │   │
│  │ - avg_reach       │   │
│  │ - total_posts     │   │
│  └───────────────────┘   │
└──────────────────────────┘

┌──────────────────────────┐
│       ab_tests           │
│  ┌───────────────────┐   │
│  │ - test_id         │   │
│  │ - tenant_id       │   │
│  │ - variant_a_post  │───references──> published_posts
│  │ - variant_b_post  │───references──> published_posts
│  │ - winner          │   │
│  │ - p_value         │   │
│  │ - confidence_level│   │
│  └───────────────────┘   │
└──────────────────────────┘


SECURITY & AUDIT:
=================

┌──────────────────────────┐
│      audit_logs          │
│  ┌───────────────────┐   │
│  │ - log_id          │   │
│  │ - tenant_id       │   │
│  │ - user_id         │   │
│  │ - action          │   │
│  │ - resource_type   │   │
│  │ - resource_id     │   │
│  │ - ip_address      │   │
│  │ - timestamp       │   │
│  └───────────────────┘   │
└──────────────────────────┘

┌──────────────────────────┐
│    sharing_events        │
│  (Skill Promotion Audit) │
│  ┌───────────────────┐   │
│  │ - event_id        │   │
│  │ - action          │   │  "promote_to_global"
│  │ - skill_id        │───references──> skills
│  │ - reason          │   │  "High performance across 5+ tenants"
│  │ - metadata JSON   │   │
│  │ - timestamp       │   │
│  └───────────────────┘   │
└──────────────────────────┘

┌──────────────────────────┐
│  brand_knowledge_entries │
│  (PER-TENANT)            │
│  ┌───────────────────┐   │
│  │ - entry_id        │   │
│  │ - tenant_id       │   │
│  │ - title           │   │
│  │ - content         │   │
│  │ - embedding BLOB  │   │  1536-dim vector
│  │ - category        │   │
│  └───────────────────┘   │
└──────────────────────────┘


VECTOR STORAGE (Cloudflare Vectorize):
=======================================

┌────────────────────────────────────────────────┐
│  Vectorize Index: nds-brand-voice              │
│  Dimensions: 1536 (text-embedding-3-small)     │
│  ┌──────────────────────────────────────┐      │
│  │ Vectors:                             │      │
│  │  - tenant_001: [0.23, -0.45, ...]   │      │
│  │  - tenant_002: [0.67, 0.12, ...]    │      │
│  │  - tenant_003: [-0.34, 0.89, ...]   │      │
│  └──────────────────────────────────────┘      │
│  Purpose: Brand voice similarity search        │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│  Vectorize Index: nds-skills                   │
│  Dimensions: 1024 (voyage-3-lite)              │
│  ┌──────────────────────────────────────┐      │
│  │ Vectors:                             │      │
│  │  - skill_linkedin_3col: [0.12, ...]  │      │
│  │  - skill_instagram_story: [0.56,...] │      │
│  │  - skill_twitter_thread: [-0.23,...] │      │
│  └──────────────────────────────────────┘      │
│  Purpose: Skill matching via similarity        │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│  Vectorize Index: nds-knowledge                │
│  Dimensions: 1536 (text-embedding-3-small)     │
│  ┌──────────────────────────────────────┐      │
│  │ Vectors (per-tenant):                │      │
│  │  - entry_abc123: [0.45, -0.23, ...]  │      │
│  │  - entry_def456: [0.78, 0.12, ...]   │      │
│  └──────────────────────────────────────┘      │
│  Purpose: Knowledge base semantic search       │
└────────────────────────────────────────────────┘


PRIVACY BOUNDARIES:
===================

┌────────────────────────────────────────────────┐
│         SHARED ACROSS TENANTS (SAFE)           │
│                                                 │
│  - skills (structural patterns)                │
│  - skill_versions (layout rules)               │
│  - skill_embeddings (similarity vectors)       │
│  - skill_metrics_daily (aggregated, K >= 5)    │
│  - guard_results (quality patterns)            │
│                                                 │
│  Privacy: Structural intelligence only         │
│  NO brand voice, assets, or performance        │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│         PER-TENANT PRIVATE (NEVER SHARED)      │
│                                                 │
│  - brand_profiles (ENCRYPTED)                  │
│  - social_accounts (ENCRYPTED)                 │
│  - generated_content                           │
│  - published_posts                             │
│  - post_analytics                              │
│  - conversions                                 │
│  - brand_knowledge_entries                     │
│  - revision_events (before K-anonymity)        │
│                                                 │
│  Enforcement: RLS + KMS encryption + audits    │
└────────────────────────────────────────────────┘


TABLE COUNT SUMMARY:
====================

Core Tables:                3
Content Generation:        10
Publishing:                 3
Analytics:                  5
Security/Audit:             3
Metrics/Benchmarks:         6
───────────────────────────────
Total:                     30


INDEXES SUMMARY:
================

Foreign Key Indexes:       12
Single-Column Indexes:     15
Composite Indexes:         13
───────────────────────────────
Total:                     40+


ENCRYPTION SUMMARY:
===================

Tables with Encrypted Fields:
- brand_profiles (embeddings, tone_vectors)
- social_accounts (access_token, refresh_token)

Encryption Method: AES-256-GCM
Key Management: Per-tenant KMS keys
Key Rotation: Every 90 days


COMPLIANCE:
===========

✅ GDPR (EU General Data Protection Regulation)
   - Data minimization
   - Right to access/deletion
   - Regional data residency
   - Breach notification process

✅ SOC 2 Type II
   - Encryption at rest/in transit
   - 99.9% uptime SLA
   - Processing integrity (guards)
   - Confidentiality (RLS, KMS)

✅ ISO 27001 (Information Security)
   - Risk assessment
   - Access control (RBAC)
   - Incident management
   - Business continuity


END OF ER DIAGRAM
=================
Version: 1.0.0
Last Updated: November 10, 2025
Maintained By: Database Architecture Team
